<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Simple Sheet</title>
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#e0e0e0">

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="favicon-96x96.png">

    <style>
        /* --- Âü∫Êú¨„Çπ„Çø„Ç§„É´ --- */
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 8px; background-color: #f0f2f5; margin: 0; box-sizing: border-box; font-size: 16px; color: #000; }
        * { box-sizing: border-box; }
        .app-grid { display: flex; gap: 12px; max-width: 1400px; margin: 0 auto; }
        .calculator-container { flex: 3; min-width: 0; background-color: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 3px 12px rgba(0, 0, 0, 0.1); width: 100%; }
        
        /* Ë°å„ÅÆ„Çπ„Çø„Ç§„É´ */
        .row { display: flex; margin-bottom: 12px; padding: 12px; border: 1px solid #ccc; border-radius: 10px; background-color: #fff; gap: 8px; }
        @media screen and (min-width: 801px) {
            .row { flex-direction: row; align-items: center; justify-content: space-between; }
            .text-label-input { flex: 1.5; }
            .calc-area { flex: 1; justify-content: center; }
            .result-area { flex: 2; justify-content: flex-end; background: #f8f9fa; padding: 5px 10px; border-radius: 6px; }
            .result-text { font-size: 1.6em; }
        }
        /* „Çπ„Éû„ÉõÁî® */
        @media screen and (max-width: 800px) {
            body { padding-top: calc(env(safe-area-inset-top) + 10px) !important; padding-left: 8px; padding-right: 8px; }
            .app-grid { display: block; }
            .calculator-container { padding: 12px; }
            .top-controls { flex-wrap: wrap; }
            .row { flex-direction: column !important; align-items: stretch !important; }
            .text-label-input { width: 100% !important; font-size: 1.1em; padding: 10px; margin-bottom: 5px; }
            .calc-area { width: 100% !important; justify-content: center !important; padding: 10px 0; border-top: 1px dashed #eee; border-bottom: 1px dashed #eee; }
            .result-area { width: 100% !important; justify-content: space-between !important; background: #eefbff; padding: 12px; border-radius: 8px; }
            .result-text { font-size: 2.2em; word-break: break-all; }
            
            .side-calc { display: none; position: fixed; bottom: 80px; right: 15px; z-index: 1000; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
            .side-calc.active { display: block; }
            .calc-toggle-btn { display: block; }
            .mobile-calc-close { display: block; }
        }
        
        /* ÂÖ•Âäõ„Éï„Ç©„Éº„É†È°û */
        .text-label-input { padding: 8px; border: 2px solid #000; border-radius: 6px; font-weight: bold; color: #000; outline: none; }
        .calc-area { display: flex; align-items: center; gap: 8px; }
        .multiplier-input { width: 110px; font-size: 1.5em; padding: 8px; text-align: right; border: 3px solid #007bff; border-radius: 6px; font-weight: bold; color: #000; outline: none; }
        .result-text { font-weight: bold; color: #007bff; }
        
        /* „Ç™„Éö„É¨„Éº„Çø„Éª„Éà„Ç∞„É´ */
        .operator-group { display: flex; flex-direction: column; align-items: center; width: 32px; }
        .operator-control { font-size: 0.7em; background: #333; color: #fff; width: 100%; height: 20px; display: flex; justify-content: center; align-items: center; border-radius: 3px; cursor: pointer; }
        .operator-display { font-size: 1.6em; font-weight: bold; text-align: center; color: #000; height: 35px; line-height: 35px; width: 100%; }
        .percent-toggle, .base-toggle { border: 2px solid #ccc; border-radius: 6px; width: 50px; height: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; font-weight: bold; background: #fff; font-size: 1.3em; flex-shrink: 0; color: #000; user-select: none; }
        .percent-toggle.active { background: #dc3545; color: #fff; border-color: #dc3545; }
        .base-toggle.chain { background: #007bff; color: #fff; border-color: #007bff; }
        .action-btn { border: none; background: none; cursor: pointer; font-size: 1.8em; opacity: 0.7; padding: 5px; }
        
        /* „Éû„Çπ„Çø„ÉºË°å */
        .master-row { padding: 12px; margin-bottom: 12px; border: 3px solid #dc3545; border-radius: 10px; background-color: #fff; display: flex; align-items: center; justify-content: space-between; }
        .master-input { width: 45%; padding: 8px; border: 2px solid #dc3545; border-radius: 6px; font-size: 1.5em; text-align: right; font-weight: bold; color: #000; outline: none; }
        
        /* „Çπ„Éà„É¨„Éº„Ç∏„Éê„Éº */
        .storage-bar { background: #dee2e6; border: 2px solid #666; border-radius: 10px; padding: 10px; margin-bottom: 12px; display: flex; flex-direction: column; gap: 8px; }
        .storage-controls { display: flex; align-items: center; gap: 10px; }
        .save-btn-main { background: #e67e22; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; white-space: nowrap; }
        .edit-toggle-btn { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1.4em; }
        
        /* „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Éê„Éº */
        .utility-bar { display: flex; justify-content: center; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .util-btn { border: none; background: #6c757d; color: white; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: bold; min-width: 60px; }
        .util-btn.manual { background: #17a2b8; width: auto; }
        .util-btn.reset { background: #dc3545; }

        /* „Çµ„Ç§„ÉâË®àÁÆóÊ©ü */
        .side-calc { flex: 1; min-width: 280px; background: #333; padding: 12px; border-radius: 10px; color: white; height: fit-content; position: sticky; top: 8px; }
        .calc-display-wrap { position: relative; margin-bottom: 10px; }
        .calc-display { width: 100%; height: 52px; background: #222; color: #fff; text-align: right; font-size: 1.8em; padding: 8px 45px 8px 8px; border-radius: 6px; border: none; outline: none; }
        .calc-copy-btn-in { position: absolute; right: 5px; top: 5px; bottom: 5px; width: 40px; background: #007bff; border: none; border-radius: 4px; font-size: 1.2em; cursor: pointer; display: flex; align-items: center; justify-content: center; opacity: 0.9; color: white; }
        
        .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
        .calc-btn { padding: 15px 5px; border: none; border-radius: 6px; cursor: pointer; font-size: 1.25em; font-weight: bold; background: #555; color: white; }
        .calc-btn.op { background: #f39c12; }
        .calc-btn.equal { background: #27ae60; grid-column: span 2; }
        .calc-btn.clear { background: #c0392b; }
        
        @media screen and (max-width: 900px) {
            .side-calc { display: none; position: fixed; bottom: 80px; right: 15px; z-index: 1000; width: 280px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
            .side-calc.active { display: block; }
        }
        
        #saveMessage { position: fixed; top: 15px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 12px 25px; border-radius: 25px; opacity: 0; transition: opacity 0.3s; z-index: 2000; pointer-events: none; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .calc-toggle-btn { display: none; position: fixed; bottom: 15px; right: 15px; width: 60px; height: 60px; border-radius: 50%; background: #333; color: white; border: none; font-size: 28px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1001; cursor: pointer; }
        @media screen and (max-width: 900px) { .calc-toggle-btn { display: block; } }
        .mobile-calc-close { display: none; background: none; border: none; color: white; font-size: 1.5em; cursor: pointer; }
        @media screen and (max-width: 900px) { .mobile-calc-close { display: block; } }

        /* „É¢„Éº„ÉÄ„É´ */
        .pro-modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); z-index: 3000; justify-content: center; align-items: center; padding: 20px; }
        .pro-modal-overlay.active { display: flex; }
        .pro-modal-content { background: #fff; padding: 25px; border-radius: 15px; text-align: center; max-width: 450px; width: 100%; box-shadow: 0 5px 20px rgba(0,0,0,0.3); animation: popIn 0.3s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .pro-icon { font-size: 3em; margin-bottom: 10px; }
        .pro-title { font-size: 1.4em; font-weight: bold; margin-bottom: 10px; color: #333; }
        .pro-desc { color: #666; margin-bottom: 20px; line-height: 1.6; text-align: left; white-space: pre-wrap; font-size: 0.95em; }
        .pro-btn-buy { display: block; width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea, #764ba2); color: white; font-weight: bold; text-decoration: none; border-radius: 25px; margin-bottom: 10px; border: none; cursor: pointer; font-size: 1.1em; }
        .pro-btn-close { background: none; border: none; color: #999; cursor: pointer; text-decoration: underline; font-size: 0.9em; }
        .url-box { width: 100%; padding: 10px; margin-bottom: 15px; background: #f0f2f5; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9em; color: #333; }
        .text-area-import { width: 100%; height: 120px; padding: 10px; margin-bottom: 15px; background: #f9f9f9; border: 1px solid #ccc; border-radius: 8px; font-size: 0.9em; color: #333; resize: none; }
        
        .title-pro-btn { display: inline-flex; align-items: center; justify-content: center; gap: 6px; background: linear-gradient(135deg, #1a237e 0%, #000 100%); color: white; text-decoration: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; font-size: 0.9em; box-shadow: 0 3px 6px rgba(0,0,0,0.15); margin: 0 auto 15px auto; transition: transform 0.2s; border:none; cursor:pointer; }
    </style>
</head>
<body onload="init()">

    <div id="saveMessage"></div>

    <div id="proModal" class="pro-modal-overlay">
        <div class="pro-modal-content" style="max-width:350px;">
            <div class="pro-icon">üíé</div>
            <div id="modalTitle" class="pro-title">Pro Feature</div>
            <div id="modalDesc" class="pro-desc" style="text-align:center;"></div>
            <button class="pro-btn-buy" id="modalBtn" onclick="alert('Coming soon with IAP!')">Upgrade to Pro</button>
            <button class="pro-btn-close" id="btnClosePro" onclick="closeProModal()">Close</button>
        </div>
    </div>

    <div id="pcModal" class="pro-modal-overlay">
        <div class="pro-modal-content" style="max-width:350px;">
            <div class="pro-icon">üíª</div>
            <div id="pcModalTitle" class="pro-title">PC / Web Version</div>
            <div id="pcModalDesc" class="pro-desc" style="margin-bottom: 10px; text-align:center;"></div>
            <input type="text" class="url-box" id="pcUrlInput" value="https://thejetdev.github.io/simple-sheet-free-v14/" readonly>
            <button class="pro-btn-buy" id="btnCopyUrl" onclick="copyPcUrl()" style="background: linear-gradient(135deg, #1a237e, #283593);">Copy URL</button>
            <button class="pro-btn-close" id="btnClosePc" onclick="closePcModal()">Close</button>
        </div>
    </div>
    
    <div id="manualModal" class="pro-modal-overlay">
        <div class="pro-modal-content">
            <div id="manTitle" class="pro-title" style="text-align:center; border-bottom:1px solid #eee; padding-bottom:10px;">Manual</div>
            <div id="manBody" class="pro-desc" style="margin-top:15px;"></div>
            <button class="pro-btn-close" onclick="closeModal('manualModal')" id="manClose" style="width:100%; text-decoration:none; background:#eee; padding:10px; border-radius:20px; font-weight:bold; color:#555;">OK</button>
        </div>
    </div>

    <div id="importModal" class="pro-modal-overlay">
        <div class="pro-modal-content" style="max-width:350px;">
            <div class="pro-title" id="impTitle">Import Data</div>
            <div class="pro-desc" id="impDesc" style="text-align:center; margin-bottom:10px;">Paste data here:</div>
            <textarea id="importText" class="text-area-import" placeholder='Paste here...'></textarea>
            <button class="pro-btn-buy" id="btnDoImport" onclick="executeImport()" style="background: #007bff;">Load Data</button>
            <button class="pro-btn-close" id="btnCloseImp" onclick="closeModal('importModal')">Close</button>
        </div>
    </div>
    
    <button class="calc-toggle-btn" onclick="toggleCalc()">üßÆ</button>

    <div class="app-grid">
        <div class="calculator-container">
            
            <div class="top-controls" style="display:flex; justify-content: space-between; align-items: center; margin-bottom:10px; flex-wrap: wrap; gap:8px;">
                <div style="flex:1; display:flex; align-items:center; border:2px solid #000; border-radius:6px; padding:6px 10px; min-width:140px; background:#fff;">
                    <span id="labelNameSpan" style="font-size:0.8em; color:#000; font-weight:bold; margin-right:8px;">Name:</span>
                    <input type="text" id="masterLabel" style="border:none; outline:none; font-weight:bold; width:100%; color:#000;" oninput="updateDisplay()">
                </div>
                <div style="display:flex; gap:5px; align-items:center;">
                    <div id="langContainer" style="display:flex; gap:3px; flex-wrap: wrap;"></div>
                </div>
            </div>

            <div class="storage-bar">
                <div class="storage-controls">
                    <button class="save-btn-main" onclick="triggerProPromo()">üíæ <span id="btnSaveMemory">Save</span></button>
                    <button id="editToggle" class="edit-toggle-btn" onclick="triggerProPromo()">üóëÔ∏è</button>
                </div>
            </div>

            <h2 id="title" style="font-weight: bold; margin-bottom: 15px; text-align:center;">Simple Sheet</h2>

            <div style="text-align: center;">
                <button class="title-pro-btn" id="btnLinkPro" onclick="triggerProPromo()">üöÄ Go to Pro Version</button>
            </div>

            <div class="utility-bar">
                <button class="util-btn manual" style="width: auto; background:#17a2b8;" onclick="openManual()" id="btnManual">üìñ Manual</button>
                <button class="util-btn" onclick="clearNumbers()">üßπ <span id="btnClear">Clear</span></button>
                <button class="util-btn" onclick="triggerProPromo()">üì§ <span id="btnExport">Exp</span></button>
                <button class="util-btn" onclick="openImport()">üì• <span id="btnImport">Imp</span></button>
                <button class="util-btn reset" onclick="fullReset()">üîÑ <span id="btnReset">Reset</span></button>
            </div>

            <div id="main-sheet-mode">
                <div class="master-row">
                    <label id="masterLabelStart" style="font-weight:bold; color:#dc3545;">Base Value</label>
                    <input type="number" id="masterInput" class="master-input" step="any" placeholder="" oninput="updateDisplay()">
                </div>
                <div id="rows-container"></div>
                <div style="text-align: center; margin-top: 15px; display: flex; gap: 8px;">
                    <button class="mode-button" id="addBtn" style="background:#28a745; color:white; flex-direction:row; min-height:auto; width:100%; justify-content:center; border:none; border-radius:6px; padding:12px; font-weight:bold; font-size:1.1rem; cursor:pointer;" onclick="addRow()">+ Row</button>
                    <button class="mode-button" id="copyBtn" style="background:#007bff; color:white; flex-direction:row; min-height:auto; width:100%; justify-content:center; border:none; border-radius:6px; padding:12px; font-weight:bold; font-size:1.1rem; cursor:pointer;" onclick="copyPage()">Copy All</button>
                </div>
            </div>

        </div>

        <div id="sideCalc" class="side-calc">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 id="ui-calcTitle" style="margin:0;">Calculator</h3>
                <button class="mobile-calc-close" onclick="toggleCalc()">√ó</button>
            </div>
            <div class="calc-display-wrap">
                <input type="text" id="calcDisplay" class="calc-display" readonly value="0">
                <button class="calc-copy-btn-in" onclick="copyCalcResult()">üìã</button>
            </div>
            <div class="calc-buttons">
                <button class="calc-btn clear" onclick="calcInput('AC')">AC</button>
                <button class="calc-btn op" onclick="calcInput('%')">%</button>
                <button class="calc-btn op" onclick="calcInput('/')">√∑</button>
                <button class="calc-btn op" onclick="calcInput('*')">√ó</button>
                <button class="calc-btn" onclick="calcInput('7')">7</button>
                <button class="calc-btn" onclick="calcInput('8')">8</button>
                <button class="calc-btn" onclick="calcInput('9')">9</button>
                <button class="calc-btn op" onclick="calcInput('-')">-</button>
                <button class="calc-btn" onclick="calcInput('4')">4</button>
                <button class="calc-btn" onclick="calcInput('5')">5</button>
                <button class="calc-btn" onclick="calcInput('6')">6</button>
                <button class="calc-btn op" onclick="calcInput('+')">+</button>
                <button class="calc-btn" onclick="calcInput('1')">1</button>
                <button class="calc-btn" onclick="calcInput('2')">2</button>
                <button class="calc-btn" onclick="calcInput('3')">3</button>
                <button class="calc-btn" onclick="calcInput('.')">.</button>
                <button class="calc-btn" onclick="calcInput('0')">0</button>
                <button class="calc-btn clear" style="background:#e67e22;" onclick="calcInput('BS')">‚å´</button>
                <button class="calc-btn equal" onclick="calcResult()">=</button>
            </div>
        </div>
    </div>

    <script>
        const languageMap = {
            en: { title: "Simple Sheet", masterLabelName: "Name:", masterLabelStart: "Base Value", rowLabel: "Label", copyMsg: "Copied!", btnClear: "Clear", btnExport: "Exp", btnImport: "Imp", btnReset: "Reset", confirmReset: "Reset all?", addRow: "+ Row", copyAll: "Copy All", calcTitle: "Calculator", btnSave: "Save", btnEdit: "Edit", 
                  proTitle: "Get Pro Version üíé", proDesc: "Save, Export, and PC Access are Pro features.\n\nBuy the app to get the URL & Passcode for the Pro Web version!", proBtn: "Go to App Store",
                  btnProLink: "üöÄ How to get Pro?", btnClose: "Close",
                  manTitle: "About Simple Sheet", 
                  manBody: "Simple Sheet is a calculator notepad.\n\n[How to Use]\n1. Enter a name and an amount.\n2. Select an operator (+ - √ó √∑) on the left.\n3. Add rows with '+ Row'.\n4. üè† Icon: Calculates based on the Base Value.\n5. üîó Icon: Calculates based on the subtotal of the row above.\n\n[Useful Features]\n„Éª% Button: Tax/Discount calculation.\n„Éªüìã Button: Copy row result.\n„ÉªCopy All: Copy the entire sheet as text.\n\n[Pro Version]\n„ÉªSave data\n„ÉªExport data\n„ÉªPC Version Access",
                  manual: "üìñ Manual", pcTitle: "PC / Web Version", pcDesc: "Open this URL on your PC:", btnCopy: "Copy URL", msgImport: "Loaded", msgImportError: "Invalid Data", impTitle:"Import Data", impDesc:"Paste data here:", btnLoad:"Load Data" },
            ja: { title: "Simple Sheet", masterLabelName: "Ë®àÁÆóÂêç:", masterLabelStart: "ÂÖÉ„ÅÆÊï∞Â≠ó", rowLabel: "È†ÖÁõÆÂêç", copyMsg: "„Ç≥„Éî„ÉºÂÆå‰∫Ü", btnClear: "„ÇØ„É™„Ç¢", btnExport: "Âá∫Âäõ", btnImport: "Ë™≠Ëæº", btnReset: "ÂàùÊúüÂåñ", confirmReset: "ÂÖ®ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü", addRow: "+ Ë°åËøΩÂä†", copyAll: "üìã „Ç™„Éº„É´„Ç≥„Éî„Éº", calcTitle: "ÈõªÂçì", btnSave: "Ë®òÊÜ∂„Åô„Çã", btnEdit: "Á∑®ÈõÜ", 
                  proTitle: "ProÁâà„ÅÆ„ÅîÊ°àÂÜÖ üíé", proDesc: "‰øùÂ≠ò„ÇÑÂá∫Âäõ„ÄÅPCÁâà„ÅÆÂà©Áî®„ÅØProÁâà„ÅÆÊ©üËÉΩ„Åß„Åô„ÄÇ\n\n„Ç¢„Éó„É™„ÇíË≥ºÂÖ•„Åô„Çã„Å®„ÄÅProÁâàWeb„Çµ„Ç§„Éà„ÅÆURL„Å®„Éë„Çπ„Ç≥„Éº„Éâ„ÅåÊâã„Å´ÂÖ•„Çä„Åæ„ÅôÔºÅ", proBtn: "„Ç¢„Éó„É™„Çπ„Éà„Ç¢„Å∏",
                  btnProLink: "üöÄ ProÁâà„Çí‰Ωø„ÅÜ„Å´„ÅØÔºü", btnClose: "Èñâ„Åò„Çã",
                  manTitle: "Simple Sheet„ÅÆ‰Ωø„ÅÑÊñπ", 
                  manBody: "„ÄêÊ¶ÇË¶Å„Äë\nSimple Sheet„ÅØ„ÄÅÁõ¥ÊÑüÁöÑ„Å´‰Ωø„Åà„Çã„É™„Çπ„ÉàÂûãË®àÁÆó„Ç¢„Éó„É™„Åß„Åô„ÄÇ„ÄåÂÖÉ„ÅÆÊï∞Â≠ó„Äç„Å´ÂØæ„Åó„Å¶„ÄÅË∂≥„ÅóÁÆó„ÇÑÂºï„ÅçÁÆó„Å™„Å©„ÅÆË®àÁÆó„Çí„É™„Çπ„ÉàÂΩ¢Âºè„ÅßÁ©ç„ÅøÈáç„Å≠„Å¶„ÅÑ„Åë„Åæ„Åô„ÄÇ\n\n„ÄêÂü∫Êú¨Êìç‰Ωú„Äë\n1. „ÄåË®àÁÆóÂêç„Äç„Å®„ÄåÂÖÉ„ÅÆÊï∞Â≠ó„Äç„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ\n2. „ÄåÈ†ÖÁõÆÂêç„Äç„Å®„ÄåÈáëÈ°ç„Äç„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ\n3. Ë°å„ÅÆÂ∑¶„Å´„ÅÇ„ÇãË®òÂè∑ÔºàÔºã, Ôºç, √ó, √∑Ôºâ„Çí„Çø„ÉÉ„Éó„Åó„Å¶Ë®àÁÆóÊñπÊ≥ï„ÇíÈÅ∏„Å≥„Åæ„Åô„ÄÇ\n4. „ÄåÔºãË°åËøΩÂä†„Äç„Éú„Çø„É≥„ÅßË®àÁÆóË°å„ÇíÂ¢ó„ÇÑ„Åõ„Åæ„Åô„ÄÇ\n\n„ÄêË®àÁÆó„É¢„Éº„ÉâÂàáÊõø„Äë\nÊï∞ÂÄ§„ÅÆÂ∑¶„Å´„ÅÇ„Çã„Ç¢„Ç§„Ç≥„É≥„Çí„Çø„ÉÉ„Éó„Åô„Çã„Å®Ë®àÁÆó„É¢„Éº„Éâ„ÅåÂ§â„Çè„Çä„Åæ„Åô„ÄÇ\nüè† („Éõ„Éº„É†): ‰∏ÄÁï™‰∏ä„ÅÆ„ÄåÂÖÉ„ÅÆÊï∞Â≠ó„Äç„Å´ÂØæ„Åó„Å¶Ë®àÁÆó„Åó„Åæ„Åô„ÄÇ\nüîó („ÉÅ„Çß„Éº„É≥): ‰∏Ä„Å§‰∏ä„ÅÆË°å„ÅÆ„ÄåË®àÁÆóÁµêÊûúÔºàÂ∞èË®àÔºâ„Äç„Å´ÂØæ„Åó„Å¶Ë®àÁÆó„Åó„Åæ„Åô„ÄÇ\n\n„Äê‰æøÂà©„Å™Ê©üËÉΩ„Äë\n„Éª%„Éú„Çø„É≥: ON„Å´„Åô„Çã„Å®ÂÖ•Âäõ„Åó„ÅüÊï∞Â≠ó„Çí„Éë„Éº„Çª„É≥„Éà„Å®„Åó„Å¶Ë®àÁÆó„Åó„Åæ„ÅôÔºà‰æã: Ê∂àË≤ªÁ®é„ÄÅÂâ≤Âºï„Å™„Å©Ôºâ„ÄÇ\n„Éªüìã„Éú„Çø„É≥: „Åù„ÅÆË°å„ÅÆË®àÁÆóÁµêÊûú„Å†„Åë„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åô„ÄÇ\n„Éª„Ç™„Éº„É´„Ç≥„Éî„Éº: ÂÖ®„Å¶„ÅÆË°å„ÅÆË®àÁÆóÁµêÊûú„Çí„ÉÜ„Ç≠„Çπ„ÉàÂΩ¢Âºè„Åß„Ç≥„Éî„Éº„Åó„Åæ„Åô„ÄÇ\n\n„ÄêProÁâàÈôêÂÆöÊ©üËÉΩ„Äë\n„Éª„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò: Á´ØÊú´„Å´„Éá„Éº„Çø„ÇíË®òÊÜ∂„Åß„Åç„Åæ„Åô„ÄÇ\n„Éª„Éá„Éº„ÇøÂá∫Âäõ: ‰ªñ„ÅÆ‰∫∫„Å´Ë®àÁÆóÁµêÊûú„ÇíÂÖ±Êúâ„Åó„Åü„Çä„ÄÅ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÇíÂèñ„Çå„Åæ„Åô„ÄÇ\n„ÉªPC/WebÁâàÈÄ£Êê∫: Â§ßÁîªÈù¢„ÅßÁ∑®ÈõÜ„Åß„Åç„Åæ„Åô„ÄÇ",
                  manual: "üìñ Ë™¨ÊòéÊõ∏", pcTitle: "PC / WebÁâà", pcDesc: "PC„Åß„Åì„ÅÆURL„ÇíÈñã„ÅÑ„Å¶„Åè„Å†„Åï„ÅÑ:", btnCopy: "URL„Çí„Ç≥„Éî„Éº", msgImport: "Ë™≠ËæºÂÆå‰∫Ü", msgImportError: "„Éá„Éº„Çø„ÅåÁÑ°Âäπ„Åß„Åô", impTitle:"„Éá„Éº„Çø„ÅÆË™≠Ëæº", impDesc:"„Åì„Åì„Å´„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ:", btnLoad:"Ë™≠ËæºÈñãÂßã" },
            zh: { title: "Simple Sheet", masterLabelName: "ÂêçÁß∞:", masterLabelStart: "ÂàùÂßãÂÄº", rowLabel: "È°πÁõÆ", copyMsg: "Â∑≤Â§çÂà∂", btnClear: "Ê∏ÖÈô§", btnExport: "ÂØºÂá∫", btnImport: "ÂØºÂÖ•", btnReset: "ÈáçÁΩÆ", confirmReset: "Á°ÆËÆ§ÈáçÁΩÆÊâÄÊúâÊï∞ÊçÆÔºü", addRow: "+ Ê∑ªÂä†Ë°å", copyAll: "Â§çÂà∂ÂÖ®ÈÉ®", calcTitle: "ËÆ°ÁÆóÂô®", btnSave: "‰øùÂ≠ò", btnEdit: "ÁºñËæë", 
                  proTitle: "ProÁâàÂäüËÉΩ üíé", proDesc: "Ë¥≠‰π∞Â∫îÁî®‰ª•Ëé∑ÂèñProÁâàURLÂíåÂØÜÁ†Å„ÄÇ", proBtn: "ÂéªÂïÜÂ∫ó",
                  btnProLink: "üöÄ Â¶Ç‰ΩïËé∑ÂèñPro?", btnClose: "ÂÖ≥Èó≠",
                  manTitle: "‰ΩøÁî®ËØ¥Êòé", manBody: "[Âü∫Êú¨Áî®Ê≥ï]\n1. ËæìÂÖ•È°πÁõÆÂíåÈáëÈ¢ù„ÄÇ\n2. ÈÄâÊã©Â∑¶‰æßÁöÑËÆ°ÁÆóÁ¨¶Âè∑„ÄÇ\n3. ÁÇπÂáª‚ÄúÊ∑ªÂä†Ë°å‚ÄùÂ¢ûÂä†Êõ¥Â§ö„ÄÇ\n4. üè†: Âü∫‰∫é‚ÄúÂàùÂßãÂÄº‚ÄùËÆ°ÁÆó„ÄÇ\n5. üîó: Âü∫‰∫é‰∏ä‰∏ÄË°åÁöÑÁªìÊûúËÆ°ÁÆó„ÄÇ\n\n[ProÁâà]\n‰øùÂ≠ò„ÄÅÂØºÂá∫„ÄÅPCÁâàËÆøÈóÆÊùÉÈôê„ÄÇ", 
                  manual: "üìñ ËØ¥Êòé‰π¶", pcTitle: "PCÁâà", pcDesc: "ËØ∑Âú®PC‰∏äÊâìÂºÄ:", btnCopy: "Â§çÂà∂URL", msgImport: "Â∑≤Âä†ËΩΩ", msgImportError: "Êó†ÊïàÊï∞ÊçÆ", impTitle:"ÂØºÂÖ•Êï∞ÊçÆ", impDesc:"ËØ∑Âú®Ê≠§Â§ÑÁ≤òË¥¥:", btnLoad:"Âä†ËΩΩ" },
            ko: { title: "Simple Sheet", masterLabelName: "Ïù¥Î¶Ñ:", masterLabelStart: "Í∏∞Ï§ÄÍ∞í", rowLabel: "Ìï≠Î™©Î™Ö", copyMsg: "Î≥µÏÇ¨Îê®", btnClear: "ÏßÄÏö∞Í∏∞", btnExport: "ÎÇ¥Î≥¥ÎÇ¥Í∏∞", btnImport: "Í∞ÄÏ†∏Ïò§Í∏∞", btnReset: "Ï¥àÍ∏∞Ìôî", confirmReset: "Ï†ÑÏ≤¥ Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?", addRow: "+ Ìñâ Ï∂îÍ∞Ä", copyAll: "Ï†ÑÏ≤¥ Î≥µÏÇ¨", calcTitle: "Í≥ÑÏÇ∞Í∏∞", btnSave: "Ï†ÄÏû•", btnEdit: "Ìé∏Ïßë", 
                  proTitle: "Pro Í∏∞Îä• üíé", proDesc: "Pro Î≤ÑÏ†ÑÏùÑ Íµ¨Îß§ÌïòÏó¨ URLÍ≥º ÏΩîÎìúÎ•º Î∞õÏúºÏÑ∏Ïöî.", proBtn: "Ïä§ÌÜ†Ïñ¥Î°ú Ïù¥Îèô",
                  btnProLink: "üöÄ Pro Î≤ÑÏ†Ñ Î∞õÍ∏∞", btnClose: "Îã´Í∏∞",
                  manTitle: "ÏÇ¨Ïö©Î≤ï", manBody: "[Í∏∞Î≥∏ ÏÇ¨Ïö©Î≤ï]\n1. Ìï≠Î™©Î™ÖÍ≥º Í∏àÏï°ÏùÑ ÏûÖÎ†•Ìï©ÎãàÎã§.\n2. ÏôºÏ™ΩÏùò Í∏∞Ìò∏(+ - √ó √∑)Î•º ÏÑ†ÌÉùÌï©ÎãàÎã§.\n3. Ìñâ Ï∂îÍ∞Ä Î≤ÑÌäºÏúºÎ°ú ÎäòÎ¶¥ Ïàò ÏûàÏäµÎãàÎã§.\n4. üè†: Í∏∞Ï§ÄÍ∞íÏùÑ Î∞îÌÉïÏúºÎ°ú Í≥ÑÏÇ∞Ìï©ÎãàÎã§.\n5. üîó: Î∞îÎ°ú ÏúóÏ§ÑÏùò Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú Í≥ÑÏÇ∞Ìï©ÎãàÎã§.\n\n[Pro Í∏∞Îä•]\nÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû•, ÎÇ¥Î≥¥ÎÇ¥Í∏∞, PC Î≤ÑÏ†Ñ ÏÇ¨Ïö©", 
                  manual: "üìñ ÏÑ§Î™ÖÏÑú", pcTitle: "PC Î≤ÑÏ†Ñ", pcDesc: "PCÏóêÏÑú Ïó¥Í∏∞:", btnCopy: "URL Î≥µÏÇ¨", msgImport: "Î°úÎìúÎê®", msgImportError: "ÏûòÎ™ªÎêú Îç∞Ïù¥ÌÑ∞", impTitle:"Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞", impDesc:"Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£Í∏∞:", btnLoad:"Î°úÎìú" },
            es: { title: "Simple Sheet", masterLabelName: "Nombre:", masterLabelStart: "Valor Base", rowLabel: "Etiqueta", copyMsg: "¬°Copiado!", btnClear: "Borrar", btnExport: "Exportar", btnImport: "Importar", btnReset: "Reiniciar", confirmReset: "¬øReiniciar todo?", addRow: "+ Fila", copyAll: "Copiar Todo", calcTitle: "Calculadora", btnSave: "Guardar", btnEdit: "Editar", 
                  proTitle: "Funci√≥n Pro üíé", proDesc: "Compre la app para obtener URL y c√≥digo Pro.", proBtn: "Ir a la tienda",
                  btnProLink: "üöÄ Obtener Pro", btnClose: "Cerrar",
                  manTitle: "Manual", manBody: "[Uso B√°sico]\n1. Ingrese nombre y monto.\n2. Elija operador (+ - √ó √∑).\n3. A√±adir filas.\n4. üè†: Calcula sobre el Valor Base.\n5. üîó: Calcula sobre el subtotal anterior.\n\n[Versi√≥n Pro]\nGuardar, Exportar, Acceso PC.", 
                  manual: "üìñ Manual", pcTitle: "Versi√≥n PC", pcDesc: "Abrir en PC:", btnCopy: "Copiar URL", msgImport: "Cargado", msgImportError: "Inv√°lido", impTitle:"Importar", impDesc:"Pegar datos aqu√≠:", btnLoad:"Cargar" },
            fr: { title: "Simple Sheet", masterLabelName: "Nom :", masterLabelStart: "Valeur de base", rowLabel: "Libell√©", copyMsg: "Copi√© !", btnClear: "Effacer", btnExport: "Export", btnImport: "Import", btnReset: "R√†Z", confirmReset: "Tout r√©initialiser ?", addRow: "+ Ligne", copyAll: "Tout Copier", calcTitle: "Calculatrice", btnSave: "Sauver", btnEdit: "Modifier", 
                  proTitle: "Fonctionnalit√© Pro üíé", proDesc: "Achetez l'app pour obtenir l'URL Pro.", proBtn: "Aller au store",
                  btnProLink: "üöÄ Obtenir Pro", btnClose: "Fermer",
                  manTitle: "Manuel", manBody: "[Utilisation]\n1. Entrez nom et montant.\n2. Choisissez l'op√©rateur.\n3. Ajoutez des lignes.\n4. üè†: Calcul sur Valeur Base.\n5. üîó: Calcul sur sous-total pr√©c√©dent.\n\n[Version Pro]\nSauvegarde, Export, Acc√®s PC.", 
                  manual: "üìñ Manuel", pcTitle: "Version PC", pcDesc: "Ouvrir sur PC:", btnCopy: "Copier l'URL", msgImport: "Charg√©", msgImportError: "Invalide", impTitle:"Importer", impDesc:"Coller ici:", btnLoad:"Charger" },
            pt: { title: "Simple Sheet", masterLabelName: "Nome:", masterLabelStart: "Valor Base", rowLabel: "R√≥tulo", copyMsg: "Copiado!", btnClear: "Limpar", btnExport: "Exportar", btnImport: "Importar", btnReset: "Reset", confirmReset: "Reiniciar tudo?", addRow: "+ Linha", copyAll: "Copiar Tudo", calcTitle: "Calculadora", btnSave: "Salvar", btnEdit: "Editar", 
                  proTitle: "Recurso Pro üíé", proDesc: "Compre o app para obter URL Pro.", proBtn: "Ir para loja",
                  btnProLink: "üöÄ Obter Pro", btnClose: "Fechar",
                  manTitle: "Manual", manBody: "[Uso B√°sico]\n1. Insira nome e valor.\n2. Escolha o operador.\n3. Adicione linhas.\n4. üè†: Calcula sobre Valor Base.\n5. üîó: Calcula sobre subtotal anterior.\n\n[Vers√£o Pro]\nSalvar, Exportar, Acesso PC.", 
                  manual: "üìñ Manual", pcTitle: "Vers√£o PC", pcDesc: "Abrir no PC:", btnCopy: "Copiar URL", msgImport: "Carregado", msgImportError: "Inv√°lido", impTitle:"Importar", impDesc:"Cole aqui:", btnLoad:"Carregar" },
            de: { title: "Simple Sheet", masterLabelName: "Name:", masterLabelStart: "Basiswert", rowLabel: "Label", copyMsg: "Kopiert!", btnClear: "L√∂schen", btnExport: "Export", btnImport: "Import", btnReset: "Reset", confirmReset: "Alles zur√ºcksetzen?", addRow: "+ Zeile", copyAll: "Alles Kopieren", calcTitle: "Rechner", btnSave: "Speichern", btnEdit: "Bearbeiten", 
                  proTitle: "Pro-Funktion üíé", proDesc: "Kaufen Sie die App f√ºr Pro-Zugang.", proBtn: "Zum Store",
                  btnProLink: "üöÄ Pro holen", btnClose: "Schlie√üen",
                  manTitle: "Anleitung", manBody: "[Basisnutzung]\n1. Name und Wert eingeben.\n2. Operator w√§hlen (+ - √ó √∑).\n3. Zeilen hinzuf√ºgen.\n4. üè†: Rechnet mit Basiswert.\n5. üîó: Rechnet mit vorherigem Ergebnis.\n\n[Pro-Version]\nSpeichern, Export, PC-Zugang.", 
                  manual: "üìñ Anleitung", pcTitle: "PC-Version", pcDesc: "Am PC √∂ffnen:", btnCopy: "URL kopieren", msgImport: "Geladen", msgImportError: "Ung√ºltig", impTitle:"Importieren", impDesc:"Hier einf√ºgen:", btnLoad:"Laden" },
            it: { title: "Simple Sheet", masterLabelName: "Nome:", masterLabelStart: "Valore Base", rowLabel: "Etichetta", copyMsg: "Copiato!", btnClear: "Cancella", btnExport: "Esporta", btnImport: "Importa", btnReset: "Reset", confirmReset: "Ripristinare tutto?", addRow: "+ Riga", copyAll: "Copia Tutto", calcTitle: "Calcolatrice", btnSave: "Salva", btnEdit: "Modifica", 
                  proTitle: "Funzione Pro üíé", proDesc: "Acquista l'app per accesso Pro.", proBtn: "Vai allo store",
                  btnProLink: "üöÄ Ottieni Pro", btnClose: "Chiudi",
                  manTitle: "Manuale", manBody: "[Uso Base]\n1. Inserisci nome e importo.\n2. Scegli operatore (+ - √ó √∑).\n3. Aggiungi righe.\n4. üè†: Calcola su Valore Base.\n5. üîó: Calcola su subtotale precedente.\n\n[Versione Pro]\nSalva, Esporta, Accesso PC.", 
                  manual: "üìñ Manuale", pcTitle: "Versione PC", pcDesc: "Apri su PC:", btnCopy: "Copia URL", msgImport: "Caricato", msgImportError: "Non valido", impTitle:"Importa", impDesc:"Incolla qui:", btnLoad:"Carica" }
        };

        let currentLanguage = 'en'; 
        let currentCalc = "0";

        function init() {
            const langCont = document.getElementById('langContainer');
            Object.keys(languageMap).forEach(lang => {
                const btn = document.createElement('button');
                btn.style.cssText = "padding:4px 6px; font-size:11px; cursor:pointer; border:1px solid #ccc; border-radius:4px; background:#fff; font-weight:bold; color:#000;";
                btn.textContent = lang.toUpperCase();
                btn.onclick = () => setLanguage(lang);
                langCont.appendChild(btn);
            });

            setLanguage(localStorage.getItem('simpleSheetLang_final') || 'en'); 
            const s = JSON.parse(localStorage.getItem('simpleSheetSettings_final') || '{}');
            applyData(s);
        }

        function setLanguage(lang) {
            currentLanguage = lang; 
            localStorage.setItem('simpleSheetLang_final', lang);
            const d = languageMap[lang];
            
            document.getElementById('title').textContent = d.title;
            document.getElementById('labelNameSpan').textContent = d.masterLabelName;
            document.getElementById('masterLabelStart').textContent = d.masterLabelStart;
            document.getElementById('btnClear').textContent = d.btnClear;
            document.getElementById('btnExport').textContent = d.btnExport;
            document.getElementById('btnImport').textContent = d.btnImport;
            document.getElementById('btnReset').textContent = d.btnReset;
            document.getElementById('addBtn').textContent = d.addRow;
            document.getElementById('copyBtn').textContent = d.copyAll;
            document.getElementById('ui-calcTitle').textContent = d.calcTitle;
            document.getElementById('btnSaveMemory').textContent = d.btnSave;
            
            document.getElementById('modalTitle').textContent = d.proTitle;
            document.getElementById('modalDesc').innerText = d.proDesc;
            document.getElementById('modalBtn').textContent = d.proBtn;
            
            document.getElementById('btnClosePro').textContent = d.btnClose;
            document.getElementById('btnLinkPro').textContent = d.btnProLink;
            
            document.getElementById('manTitle').textContent = d.manTitle;
            document.getElementById('manBody').innerText = d.manBody;
            document.getElementById('manClose').textContent = d.btnClose;
            document.getElementById('btnManual').textContent = d.manual;

            document.getElementById('pcModalTitle').textContent = d.pcTitle;
            document.getElementById('pcModalDesc').textContent = d.pcDesc;
            document.getElementById('btnCopyUrl').textContent = d.btnCopy;
            document.getElementById('btnClosePc').textContent = d.btnClose;

            document.getElementById('impTitle').textContent = d.impTitle;
            document.getElementById('impDesc').textContent = d.impDesc;
            document.getElementById('btnDoImport').textContent = d.btnLoad;
            document.getElementById('btnCloseImp').textContent = d.btnClose;

            document.querySelectorAll('.text-label-input').forEach(input => {
                input.placeholder = d.rowLabel;
            });

            updateDisplay();
        }

        function triggerProPromo() { document.getElementById('proModal').classList.add('active'); }
        function closeProModal() { document.getElementById('proModal').classList.remove('active'); }
        function triggerPcModal() { document.getElementById('pcModal').classList.add('active'); }
        function closePcModal() { document.getElementById('pcModal').classList.remove('active'); }
        function copyPcUrl() {
            const urlInput = document.getElementById('pcUrlInput');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(urlInput.value);
            showMsg(languageMap[currentLanguage].copyMsg);
        }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }
        function openManual() { document.getElementById('manualModal').classList.add('active'); }
        function openImport() { 
            document.getElementById('importText').value = "";
            document.getElementById('importModal').classList.add('active'); 
        }

        // Ë®àÁÆóË™§Â∑Æ„Çí„Å™„Åè„ÅôÈñ¢Êï∞ (Â∞èÊï∞Á¨¨10‰Ωç„Åß‰∏∏„ÇÅ„Çã„Åì„Å®„Åß„ÄÅ0.0000004„ÅÆ„Çà„ÅÜ„Å™„Ç¥„Éü„ÇíÊ∂à„Åô)
        function stripError(num) {
            return parseFloat(num.toPrecision(12));
        }

        function formatNum(num) {
            // ÊúÄÂ§ß3Ê°Å„Åæ„ÅßË°®Á§∫„ÄÅË™§Â∑Æ„ÇíÈô§Âéª„Åó„Å¶„Åã„Çâ„Éï„Ç©„Éº„Éû„ÉÉ„Éà
            return stripError(num).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 3 });
        }

        function updateDisplay() {
            // ÂÖ®ËßíÊï∞Â≠ó„Å®ÂÖ®Ëßí„Éâ„ÉÉ„Éà„ÄåÔºé„Äç„ÇíÂçäËßí„Å´Â§âÊèõ
            const masterValStr = document.getElementById('masterInput').value
                .replace(/[Ôºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .replace(/Ôºé/g, '.');
            
            const mVal = parseFloat(masterValStr) || 0;
            let chain = mVal;
            
            document.querySelectorAll('#rows-container .row').forEach(r => {
                const opEl = r.querySelector('.operator-display');
                const op = opEl ? opEl.textContent.trim() : '+';
                
                const inputValStr = r.querySelector('.multiplier-input').value
                    .replace(/[Ôºê-Ôºô]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                    .replace(/Ôºé/g, '.');

                const mult = parseFloat(inputValStr) || 0;
                
                const pct = r.querySelector('.percent-toggle').classList.contains('active');
                const isChain = r.querySelector('.base-toggle').classList.contains('chain');
                const base = isChain ? chain : mVal;
                
                // ‚òÖ‰øÆÊ≠£ÔºöÊµÆÂãïÂ∞èÊï∞ÁÇπË®àÁÆó„ÅÆË™§Â∑ÆÂØæÁ≠ñ
                // Ë®àÁÆó„ÅÆ„Åü„Å≥„Å´ stripError „ÇíÈÄö„Åô„Åì„Å®„Åß„Ç∫„É¨„ÇíÈò≤„Åê
                let mod = pct ? stripError(base * (mult / 100)) : mult;
                let res = 0;
                
                if(op === '+' || op === 'Ôºã') res = base + mod;
                else if(op === '-' || op === '‚àí' || op === '„Éº') res = base - mod;
                else if(op === '√ó' || op === '*' || op === 'Ôºä' || op === 'x' || op === 'X') res = pct ? stripError(base * (mult / 100)) : stripError(base * mult);
                else if(op === '√∑' || op === '/' || op === 'Ôºè') res = mult !== 0 ? stripError(base / mult) : 0;
                else res = base + mod;
                
                // ÁµêÊûúË°®Á§∫Ââç„Å´ÊúÄÁµÇÁöÑ„Å™„Ç¥„ÉüÂèñ„Çä„ÇíË°å„ÅÜ
                res = stripError(res);
                
                r.querySelector('.result-text').textContent = formatNum(res);
                chain = res;
            });
            saveSettings();
        }

        function getScreenData() {
            return {
                masterLabel: document.getElementById('masterLabel').value,
                masterInput: document.getElementById('masterInput').value,
                rows: Array.from(document.querySelectorAll('#rows-container .row')).map(r => ({
                    id: r.dataset.id, 
                    label: r.querySelector('.text-label-input').value, 
                    multiplier: r.querySelector('.multiplier-input').value, 
                    operator: r.querySelector('.operator-display').textContent.trim(), 
                    isPercentActive: r.querySelector('.percent-toggle').classList.contains('active'), 
                    baseMode: r.querySelector('.base-toggle').classList.contains('chain') ? 'chain' : 'master'
                }))
            };
        }

        function applyData(s) {
            if(!s) return;
            document.getElementById('masterLabel').value = s.masterLabel || s.name || s.n || '';
            document.getElementById('masterInput').value = s.masterInput || s.base || s.b || '';
            document.getElementById('rows-container').innerHTML = '';
            
            let rowsToLoad = s.r || s.rows || s.simpleRows;
            if(rowsToLoad) { 
                rowsToLoad.forEach(r => {
                    let op = r.operator || r.o || '+';
                    if (op === '*') op = '√ó';
                    if (op === '/') op = '√∑';
                    
                    let rowData = {
                        label: r.label || r.n || '',
                        multiplier: (r.multiplier !== undefined) ? r.multiplier : (r.p !== undefined ? r.p : ''),
                        operator: op,
                        isPercentActive: (r.isPercentActive !== undefined) ? r.isPercentActive : (r.pct || false),
                        baseMode: (r.baseMode) ? r.baseMode : ((r.c === true) ? 'chain' : 'master')
                    };
                    addRow(rowData);
                }); 
            } else { 
                addRow(); 
            }
            updateDisplay();
        }

        function saveSettings(){ 
            localStorage.setItem('simpleSheetSettings_final', JSON.stringify(getScreenData())); 
        }

        function addRow(s=null) {
            const id = s ? s.id : Math.random().toString(36).substr(2, 5);
            const ph = languageMap[currentLanguage].rowLabel;
            const div = document.createElement('div'); 
            div.className = 'row'; 
            div.dataset.id = id;
            const isChain = s ? s.baseMode==='chain' : true; 
            const val = s ? s.multiplier : '';

            div.innerHTML = `
                <input type="text" class="text-label-input" placeholder="${ph}" value="${s?s.label:''}" oninput="saveSettings()">
                <div class="calc-area">
                    <div id="base-${id}" class="base-toggle ${isChain?'chain':''}" onclick="this.classList.toggle('chain');this.textContent=this.classList.contains('chain')?'üîó':'üè†';updateDisplay()">
                        ${isChain?'üîó':'üè†'}
                    </div>
                    <div class="operator-group">
                        <div class="operator-control" onclick="changeOp('${id}',1)">‚ñ≤</div>
                        <div class="operator-display" id="op-${id}">${s?s.operator:'+'}</div>
                        <div class="operator-control" onclick="changeOp('${id}',-1)">‚ñº</div>
                    </div>
                    <input type="number" step="any" class="multiplier-input" value="${val}" placeholder="" oninput="updateDisplay()">
                    <div class="percent-toggle ${s&&s.isPercentActive?'active':''}" onclick="this.classList.toggle('active');updateDisplay()">%</div>
                </div>
                <div class="result-area">
                    <div class="result-text">0</div>
                    <div style="display:flex; gap:10px;">
                        <button class="action-btn" onclick="copyRowVal(this)">üìã</button>
                        <button class="action-btn" onclick="this.closest('.row').remove();updateDisplay()">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            document.getElementById('rows-container').appendChild(div); 
            updateDisplay();
        }

        function changeOp(id, d) { 
            const ops = ['+','-','√ó','√∑']; 
            const el = document.getElementById('op-'+id).closest('.row').querySelector('.operator-display');
            const currentOp = el.textContent.trim();
            el.textContent = ops[(ops.indexOf(currentOp) + d + 4) % 4]; 
            updateDisplay(); 
        }

        function copyRowVal(btn) { 
            navigator.clipboard.writeText(btn.closest('.result-area').querySelector('.result-text').textContent.replace(/,/g,'')); 
            showMsg(languageMap[currentLanguage].copyMsg); 
        }

        function copyPage() { 
            let t = `„Äê${document.getElementById('masterLabel').value || 'Sheet'}„Äë\n`;
            document.querySelectorAll('#rows-container .row').forEach(r => { 
                const op = r.querySelector('.operator-display').textContent.trim();
                t += `${r.querySelector('.text-label-input').value || '-'}\t${op}\t${r.querySelector('.multiplier-input').value}\t=\t${r.querySelector('.result-text').textContent.replace(/,/g,'')}\n`; 
            });
            navigator.clipboard.writeText(t); 
            showMsg(languageMap[currentLanguage].copyMsg);
        }

        function executeImport() {
            const text = document.getElementById('importText').value;
            if(!text) return;
            try {
                const j = JSON.parse(text);
                applyData(j);
                showMsg(languageMap[currentLanguage].msgImport);
                closeModal('importModal');
            } catch(e) {
                if(tryParseText(text)) {
                    showMsg(languageMap[currentLanguage].msgImport);
                    closeModal('importModal');
                } else {
                    showMsg(languageMap[currentLanguage].msgImportError);
                }
            }
        }

        function tryParseText(text) {
            const lines = text.trim().split(/\r?\n/);
            if (lines.length < 1) return false;

            let name = "";
            let base = 0;
            let rows = [];
            let startRowIdx = 0;

            if (!isNaN(parseFloat(lines[0])) && lines[0].trim().match(/^[\d\.-]+$/)) {
                base = parseFloat(lines[0]);
                startRowIdx = 1;
            } else {
                name = lines[0].trim().replace(/^„Äê|„Äë$/g, ''); 
                if (lines.length > 1 && !isNaN(parseFloat(lines[1]))) {
                    base = parseFloat(lines[1]);
                    startRowIdx = 2;
                } else {
                    startRowIdx = 1;
                }
            }

            for (let i = startRowIdx; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                let parts = line.split(/\t+/);
                if (parts.length < 2) parts = line.split(/\s{2,}/);
                
                if (parts.length < 2) {
                    const match = line.match(/^(.*)\s+([\d,\.-]+)$/);
                    if (match) {
                        parts = [match[1].trim(), match[2]];
                    }
                }

                if (parts.length >= 2) {
                    const val = parseFloat(parts[parts.length-1].replace(/,/g, '')) || 0;
                    const label = parts.slice(0, parts.length-1).join(" ").trim();
                    rows.push({
                        label: label,
                        multiplier: val,
                        operator: '+', 
                        baseMode: 'chain',
                        isPercentActive: false
                    });
                }
            }

            if (rows.length === 0 && base === 0 && !name) return false;

            document.getElementById('masterLabel').value = name;
            document.getElementById('masterInput').value = base;
            document.getElementById('rows-container').innerHTML = "";
            rows.forEach(r => addRow(r));
            updateDisplay();
            return true;
        }

        function calcInput(v) { 
            if(v === 'AC') { currentCalc = "0"; }
            else if(v === 'BS') { currentCalc = currentCalc.length > 1 ? currentCalc.slice(0, -1) : "0"; }
            else {
                if(currentCalc === "0" && v !== ".") currentCalc = v; 
                else currentCalc += v; 
            }
            document.getElementById('calcDisplay').value = currentCalc; 
        }
        
        function calcResult() { 
            try { 
                let expression = currentCalc.replace(/√ó/g, '*').replace(/√∑/g, '/').replace(/%/g, '/100');
                let res = eval(expression); 
                // ÈõªÂçìÂÅ¥„ÇÇË™§Â∑Æ‰øÆÊ≠£„ÇíÈÅ©Áî®
                currentCalc = stripError(res).toString();
            } catch(e) { 
                currentCalc = "Error"; 
            } 
            document.getElementById('calcDisplay').value = currentCalc; 
        }
        function copyCalcResult() { 
            navigator.clipboard.writeText(document.getElementById('calcDisplay').value); 
            showMsg(languageMap[currentLanguage].copyMsg); 
        }
        function toggleCalc() { 
            document.getElementById('sideCalc').classList.toggle('active'); 
        }

        function clearNumbers() { 
            document.getElementById('masterInput').value = ""; 
            document.querySelectorAll('.multiplier-input').forEach(i => i.value = ""); 
            updateDisplay(); 
        }
        function fullReset() { 
            if(confirm(languageMap[currentLanguage].confirmReset)) { 
                localStorage.removeItem('simpleSheetSettings_final'); 
                location.reload(); 
            } 
        }
        function showMsg(t) { 
            const m = document.getElementById('saveMessage'); 
            m.textContent = t; 
            m.style.opacity = 1; 
            setTimeout(() => m.style.opacity = 0, 1500); 
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').catch(err => console.log('SW failed', err));
            });
        }
    </script>
</body>
</html>
